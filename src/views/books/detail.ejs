<div class="container">
    <div class="page-header fade-in">
        <h1 class="page-title">
            <i class="fas fa-book-open"></i> <%= book.title %>
        </h1>
        <div style="display: flex; gap: 8px;">
            <a href="/books/edit/<%= book.id %>" class="btn btn-secondary">
                <i class="fas fa-edit"></i> <%= __('bookDetail.edit') %>
            </a>
            <a href="/books" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> <%= __('bookDetail.back') %>
            </a>
        </div>
    </div>

    <div class="grid grid-2" style="align-items: start;">
        <div class="card fade-in-d1">
            <% if (book.cover_image) { %>
                <img src="<%= book.cover_image %>" alt="<%= book.title %>"
                    style="width: 100%; border-radius: var(--radius-sm); margin-bottom: 24px;">
            <% } else { %>
                <div style="width: 100%; height: 340px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; color: white; font-size: 5rem; margin-bottom: 24px;">
                    <i class="fas fa-book"></i>
                </div>
            <% } %>

            <h2 style="font-size: 1.4rem; font-weight: 800; margin-bottom: 8px; letter-spacing: -0.3px;"><%= book.title %></h2>
            <p style="color: var(--text-muted); font-size: 1rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-user"></i> <%= book.author %>
            </p>

            <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">
                <% if (book.status === 'reading') { %>
                    <span class="badge badge-primary"><i class="fas fa-book-reader"></i> <%= __('bookStatus.reading') %></span>
                <% } else if (book.status === 'completed') { %>
                    <span class="badge badge-success"><i class="fas fa-check"></i> <%= __('bookStatus.completed') %></span>
                <% } else { %>
                    <span class="badge badge-warning"><i class="fas fa-bookmark"></i> <%= __('bookStatus.wantToRead') %></span>
                <% } %>
                <% if (book.category) { %>
                    <span class="badge badge-primary"><i class="fas fa-tag"></i> <%= book.category %></span>
                <% } %>
            </div>

            <% if (book.rating) { %>
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: 600; display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-secondary);"><%= __('bookDetail.ratingLabel') %></label>
                    <div class="rating">
                        <% for (let i = 1; i <= 5; i++) { %>
                            <span class="rating-star <%= i <= book.rating ? '' : 'empty' %>">&#9733;</span>
                        <% } %>
                    </div>
                </div>
            <% } %>

            <% if (book.summary) { %>
                <div>
                    <label style="font-weight: 600; display: block; margin-bottom: 6px; font-size: 0.85rem; color: var(--text-secondary);"><%= __('bookDetail.summaryLabel') %></label>
                    <p style="color: var(--text-sub); line-height: 1.8; font-size: 0.93rem;"><%= book.summary %></p>
                </div>
            <% } %>

            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                <small style="color: var(--text-muted); font-size: 0.8rem;">
                    <i class="fas fa-calendar"></i> <%= __('bookDetail.addedOn') %> <%= new Date(book.created_at).toLocaleDateString() %>
                </small>
            </div>
        </div>

        <div>
            <div class="card fade-in-d2" style="margin-bottom: 20px;">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <span><i class="fas fa-sticky-note" style="color: var(--primary);"></i> <%= __('notes.title') %> (<%= notes.length %>)</span>
                    <button type="button" class="btn btn-sm btn-primary" id="toggleNoteBtn">
                        <i class="fas fa-plus"></i> <%= __('notes.add') %>
                    </button>
                </div>

                <div id="noteForm" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <form action="/books/<%= book.id %>/notes" method="POST">
                        <div class="form-group">
                            <label for="note_content" class="form-label"><%= __('notes.contentLabel') %></label>
                            <textarea id="note_content" name="content" class="form-control" rows="4"
                                placeholder="<%= __('notes.contentPlaceholder') %>" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="page_number" class="form-label"><%= __('notes.pageNumber') %></label>
                            <input type="number" id="page_number" name="page_number" class="form-control"
                                placeholder="e.g. 42" min="1">
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                <i class="fas fa-save"></i> <%= __('notes.save') %>
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancelNoteBtn">
                                <%= __('notes.cancel') %>
                            </button>
                        </div>
                    </form>
                </div>

                <div style="margin-top: 16px;">
                    <% if (notes.length === 0) { %>
                        <p style="color: var(--text-muted); text-align: center; padding: 32px 16px; font-size: 0.88rem;">
                            <i class="fas fa-inbox" style="display: block; font-size: 2rem; margin-bottom: 8px; opacity: 0.4;"></i>
                            <%= __('notes.empty') %>
                        </p>
                    <% } else { %>
                        <% notes.forEach(note => { %>
                            <div class="note-item">
                                <% if (note.page_number) { %>
                                    <span class="badge badge-primary" style="position: absolute; top: 10px; right: 10px;">
                                        <%= __('notes.page') %> <%= note.page_number %>
                                    </span>
                                <% } %>
                                <p style="margin-bottom: 10px; color: var(--text); font-size: 0.91rem; line-height: 1.7;"><%= note.content %></p>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <small style="color: var(--text-muted); font-size: 0.76rem;">
                                        <i class="fas fa-clock"></i> <%= new Date(note.created_at).toLocaleDateString() %>
                                    </small>
                                    <form action="/books/<%= book.id %>/notes/<%= note.id %>/delete" method="POST" style="display: inline;">
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('<%= __('notes.confirmDelete') %>')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        <% }) %>
                    <% } %>
                </div>
            </div>

            <div class="card fade-in-d3">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <span><i class="fas fa-quote-right" style="color: var(--secondary);"></i> <%= __('quotes.title') %> (<%= quotes.length %>)</span>
                    <button type="button" class="btn btn-sm btn-primary" id="toggleQuoteBtn">
                        <i class="fas fa-plus"></i> <%= __('quotes.add') %>
                    </button>
                </div>

                <div id="quoteForm" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <form action="/books/<%= book.id %>/quotes" method="POST">
                        <div class="form-group">
                            <label for="quote_text" class="form-label"><%= __('quotes.textLabel') %></label>
                            <textarea id="quote_text" name="text" class="form-control" rows="3"
                                placeholder="<%= __('quotes.textPlaceholder') %>" required></textarea>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                <i class="fas fa-save"></i> <%= __('quotes.save') %>
                            </button>
                            <button type="button" class="btn btn-secondary" id="cancelQuoteBtn">
                                <%= __('quotes.cancel') %>
                            </button>
                        </div>
                    </form>
                </div>

                <div style="margin-top: 16px;">
                    <% if (quotes.length === 0) { %>
                        <p style="color: var(--text-muted); text-align: center; padding: 32px 16px; font-size: 0.88rem;">
                            <i class="fas fa-inbox" style="display: block; font-size: 2rem; margin-bottom: 8px; opacity: 0.4;"></i>
                            <%= __('quotes.empty') %>
                        </p>
                    <% } else { %>
                        <% quotes.forEach(quote => { %>
                            <div class="quote-item <%= quote.is_favorite ? 'favorited' : '' %>">
                                <p style="font-style: italic; color: var(--text); font-size: 1rem; margin-bottom: 14px; line-height: 1.8;">
                                    &ldquo;<%= quote.text %>&rdquo;
                                </p>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <small style="color: var(--text-muted); font-size: 0.76rem;">
                                        <i class="fas fa-clock"></i> <%= new Date(quote.created_at).toLocaleDateString() %>
                                    </small>
                                    <div style="display: flex; gap: 6px;">
                                        <form action="/books/<%= book.id %>/quotes/<%= quote.id %>/favorite" method="POST" style="display: inline;">
                                            <button type="submit" class="btn btn-sm <%= quote.is_favorite ? 'btn-warning' : 'btn-secondary' %>">
                                                <i class="<%= quote.is_favorite ? 'fas' : 'far' %> fa-star"></i>
                                            </button>
                                        </form>
                                        <form action="/books/<%= book.id %>/quotes/<%= quote.id %>/delete" method="POST" style="display: inline;">
                                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('<%= __('quotes.confirmDelete') %>')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var noteForm = document.getElementById('noteForm');
        var quoteForm = document.getElementById('quoteForm');

        document.getElementById('toggleNoteBtn').addEventListener('click', function() {
            noteForm.style.display = noteForm.style.display === 'none' ? 'block' : 'none';
        });
        document.getElementById('cancelNoteBtn').addEventListener('click', function() {
            noteForm.style.display = 'none';
        });
        document.getElementById('toggleQuoteBtn').addEventListener('click', function() {
            quoteForm.style.display = quoteForm.style.display === 'none' ? 'block' : 'none';
        });
        document.getElementById('cancelQuoteBtn').addEventListener('click', function() {
            quoteForm.style.display = 'none';
        });
    });
</script>
